<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI ì‚°ë¶ˆ ê°ì§€ ì‹œìŠ¤í…œ (6ì±„ë„ ëª¨ë‹ˆí„°ë§)</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.95);
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* 3x2 ì˜ìƒ ë ˆì´ì•„ì›ƒ */
    .grid-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 15px;
      width: 95%;
      height: 90%;
    }

    /* ê° ì˜ìƒ ì¹´ë“œ */
    .video-box {
      position: relative;
      background: #f7f7f7;
      border-radius: 10px;
      border: 2px solid #ccc;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    /* í—¤ë” */
    .video-header {
      background: #333;
      color: white;
      padding: 8px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
    }

    /* ì˜ìƒ */
    video {
      width: 100%;
      height: 80%;
      background: black;
    }

    /* ë²„íŠ¼ ê·¸ë£¹ */
    .controls {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 8px;
    }

    button {
      background-color: #444;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 6px 10px;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover {
      background-color: #ff5722;
    }

    button:disabled {
      background-color: #888;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <div class="grid-container">
    <!-- 6ê°œì˜ ì˜ìƒ ë°•ìŠ¤ -->
    <div class="video-box" id="cam1">
      <div class="video-header">1</div>
      <video id="video1" autoplay muted playsinline></video>
      <div class="controls">
        <button onclick="startRecording(1)">ì‹œì‘</button>
        <button onclick="stopRecording(1)" disabled>ì¢…ë£Œ</button>
      </div>
    </div>

    <div class="video-box" id="cam2">
      <div class="video-header">2</div>
      <video id="video2" autoplay muted playsinline></video>
      <div class="controls">
        <button onclick="startRecording(2)">ì‹œì‘</button>
        <button onclick="stopRecording(2)" disabled>ì¢…ë£Œ</button>
      </div>
    </div>

    <div class="video-box" id="cam3">
      <div class="video-header">3</div>
      <video id="video3" autoplay muted playsinline></video>
      <div class="controls">
        <button onclick="startRecording(3)">ì‹œì‘</button>
        <button onclick="stopRecording(3)" disabled>ì¢…ë£Œ</button>
      </div>
    </div>

    <div class="video-box" id="cam4">
      <div class="video-header">4</div>
      <video id="video4" autoplay muted playsinline></video>
      <div class="controls">
        <button onclick="startRecording(4)">ì‹œì‘</button>
        <button onclick="stopRecording(4)" disabled>ì¢…ë£Œ</button>
      </div>
    </div>

    <div class="video-box" id="cam5">
      <div class="video-header">5</div>
      <video id="video5" autoplay muted playsinline></video>
      <div class="controls">
        <button onclick="startRecording(5)">ì‹œì‘</button>
        <button onclick="stopRecording(5)" disabled>ì¢…ë£Œ</button>
      </div>
    </div>

    <div class="video-box" id="cam6">
      <div class="video-header">6</div>
      <video id="video6" autoplay muted playsinline></video>
      <div class="controls">
        <button onclick="startRecording(6)">ì‹œì‘</button>
        <button onclick="stopRecording(6)" disabled>ì¢…ë£Œ</button>
      </div>
    </div>
  </div>

  <script>
    // ë…¹í™” ê´€ë ¨ ë³€ìˆ˜
    const mediaRecorders = {};
    const recordedChunks = {};
    const streams = {};

    // ë…¹í™” ì‹œì‘
    function startRecording(id) {
      const video = document.getElementById(`video${id}`);
      const startBtn = video.parentElement.querySelector('button:nth-child(1)');
      const stopBtn = video.parentElement.querySelector('button:nth-child(2)');

      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
          video.srcObject = stream;
          streams[id] = stream;

          const recorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp9' });
          mediaRecorders[id] = recorder;
          recordedChunks[id] = [];

          recorder.ondataavailable = e => recordedChunks[id].push(e.data);
          recorder.onstop = () => {
            const blob = new Blob(recordedChunks[id], { type: 'video/webm' });
            uploadAndAnalyzeVideo(blob, id);
          };

          recorder.start();
          startBtn.disabled = true;
          stopBtn.disabled = false;
          console.log(`ğŸ“¹ CCTV ${id} ë…¹í™” ì‹œì‘`);
        })
        .catch(err => {
          console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', err);
          alert('ì¹´ë©”ë¼ ì ‘ê·¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
        });
    }

    // ë…¹í™” ì¢…ë£Œ
    function stopRecording(id) {
      const recorder = mediaRecorders[id];
      const stream = streams[id];
      const video = document.getElementById(`video${id}`);
      const startBtn = video.parentElement.querySelector('button:nth-child(1)');
      const stopBtn = video.parentElement.querySelector('button:nth-child(2)');

      if (recorder && recorder.state !== 'inactive') {
        recorder.stop();
        stream.getTracks().forEach(track => track.stop());
        startBtn.disabled = false;
        stopBtn.disabled = true;
        console.log(`â¹ CCTV ${id} ë…¹í™” ì¢…ë£Œ`);
      }
    }

    // ì—…ë¡œë“œ ë° ë¶„ì„ ìš”ì²­
    function uploadAndAnalyzeVideo(blob, id) {
      const formData = new FormData();
      formData.append('video', blob, `cctv${id}.webm`);

      fetch('/introduction/uploadAndAnalyze', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert(`âœ… CCTV ${id} ë¶„ì„ ì™„ë£Œ! ê²°ê³¼ ì˜ìƒì„ í™•ì¸í•˜ì„¸ìš”.`);
          window.open(data.resultPath, '_blank');
        } else {
          alert(`âŒ CCTV ${id} ë¶„ì„ ì‹¤íŒ¨: ${data.error}`);
        }
      })
      .catch(err => {
        console.error('ì—…ë¡œë“œ ë° ë¶„ì„ ì˜¤ë¥˜:', err);
        alert(`âŒ CCTV ${id} ì„œë²„ í†µì‹  ì‹¤íŒ¨`);
      });
    }
  </script>
</body>
</html>
